<!DOCTYPE html>

<html>
<head>
  <title>
  Tree-Drawing jQuery Plugin
  </title>

  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.css" />
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.css" />
  <link rel="stylesheet" type="text/css" href="index.css" />
</head>

<body>
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <ul class="nav nav-justified navbar-nav">
        <li class="">
          <a href="javascript:void(0)" onclick="buildAndRefreshTree()">Draw Tree</a>
        </li>
        <li class="">
          <a href="javascript:void(0)" onclick="buildAndRefreshSettings()">Refresh Settings Displayed</a>
        </li>
      </ul>
    </div>
  </nav>
  <div role="main" class="main-container">
    <h1 class="col-xs-12 col-sm-12 col-md-12">Tree-Drawing jQuery Plugin Demo Site</h1>
  
      <div class="col-xs-6 col-sm-6 col-md-6">
        <h3>Choose Settings Source</h3>
        <div class="options-module">
          <div class="radio">
            <label>
              <input type="radio" name="settings-source" id="settings-source-0" value="default" checked>
              Default Settings
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="settings-source" id="settings-source-1" value="user">
              User Settings
            </label>
          </div>
        </div>
      </div>

      <div class="col-xs-6 col-sm-6 col-md-6">
        <h3>Choose Data Source</h3>
        <div class="options-module">
          <div class="radio">
            <label>
              <input type="radio" name="data-source" id="data-source-0" value="default" checked>
              Default Data
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="data-source" id="data-source-1" value="user">
              User Data
            </label>
          </div>
        </div>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-12">
        <h3>Generated Tree Output</h3>
        <div class="output-container" id="tree-container"></div>
      </div>
  
    <div id="options-container" class="col-xs-12 col-sm-12 col-md-12">
      <h3>Tree Settings Customization</h3>
      <table class="table">
        <tr>
          <td><label for="option-tree-container-id">Tree Container ID (Disabled)</label></td>
          <td><input type="text" id="option-tree-container-id" /></td>
        </tr>
        <tr>
          <td><label for="option-child-node-name">Child Node Prop Name</label></td>
          <td><input type="text" id="option-child-node-name" /></td>
        </tr>
        <tr>
          <td><label for="option-node-data-name">Node Data Prop Name</label></td>
          <td><input type="text" id="option-node-data-name" /></td>
        </tr>
        <tr>
          <td><label for="tree-orientation">Tree Orientation</label></td>
          <td class="options-module">
            <div class="radio">
              <label>
                <input type="radio" name="tree-orientation" id="tree-orientation-down" value="down">
                Down
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="tree-orientation" id="tree-orientation-left" value="left">
                Left
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="tree-orientation" id="tree-orientation-up" value="up">
                Up
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="tree-orientation" id="tree-orientation-right" value="right">
                Right
              </label>
            </div>
          </td>
        </tr>
        <tr>
          <td><label for="link-orientation">Link Orientation</label></td>
          <td class="options-module">
            <div class="radio">
              <label>
                <input type="radio" name="link-orientation" id="link-orientation-down" value="down">
                Down Tree
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="link-orientation" id="link-orientation-up" value="up">
                Up Tree
              </label>
            </div>
          </td>
        </tr>
        <tr>
          <td><label for="option-link-strategy">Link Strategy</label></td>
          <td class="options-module">
            <div class="radio">
              <label>
                <input type="radio" name="option-link-strategy" id="option-link-strategy-elbow" value="elbow">
                Elbow Links
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="option-link-strategy" id="option-link-strategy-diag" value="diagonal">
                Curved Links
              </label>
            </div>
          </td>
        </tr>
        <tr>
          <td><label for="option-node-width">Node Width (px)</label></td>
          <td><input type="text" id="option-node-width" /></td>
        </tr>
        <tr>
          <td><label for="option-node-width">Node Height (px)</label></td>
          <td><input type="text" id="option-node-height" /></td>
        </tr>
        <tr>
          <td><label for="option-node-depth-spacing">Node Depth Spacing (px)</label></td>
          <td><input type="text" id="option-node-depth-spacing" /></td>
        </tr>
        <tr>
          <td><label for="option-node-sibling-spacing">Node Sibling Spacing (px)</label></td>
          <td><input type="text" id="option-node-sibling-spacing" /></td>
        </tr>
        <tr>
          <td class="option-label-column">
            <label for="option-node-background-classes">Node Background Classes</label><br>
            <span class="add-row-button disableDblClick" data-listid="#option-node-background-classes">Add Class Row</span>
          </td>
          <td class="option-input-column">
            <ul id="option-node-background-classes" class="option-list">
              <li class="option-list-item">
                <input type="text" id="option-node-background-item-0" class="option-list-item-input" />
              </li>
            </ul>
          </td>
        </tr>
        <tr>
          <td class="option-label-column">
            <label for="option-node-html-classes">Node HTML Template Classes</label><br>
            <span class="add-row-button disableDblClick" data-listid="#option-node-html-classes">Add Class Row</span>
          </td>
          <td class="option-input-column">
            <ul id="option-node-html-classes" class="option-list">
              <li class="option-list-item">
                <input type="text" id="option-node-html-item-0" class="option-list-item-input" />
              </li>
            </ul>
          </td>
        </tr>
        <tr>
          <td class="option-label-column">
            <label for="option-link-body-classes">Link Body Classes</label><br>
            <span class="add-row-button disableDblClick" data-listid="#option-link-body-classes">Add Class Row</span>
          </td>
          <td class="option-input-column">
            <ul id="option-link-body-classes" class="option-list">
              <li class="option-list-item">
                <input type="text" id="option-link-body-item-0" class="option-list-item-input" />
              </li>
            </ul>
          </td>
        </tr>
        <tr>
          <td class="option-label-column">
            <label for="option-link-arrow-classes">Link Arrow Classes</label><br>
            <span class="add-row-button disableDblClick" data-listid="#option-link-arrow-classes">Add Class Row</span>
          </td>
          <td class="option-input-column">
            <ul id="option-link-arrow-classes" class="option-list">
              <li class="option-list-item">
                <input type="text" id="option-link-arrow-item-0" class="option-list-item-input" />
              </li>
            </ul>
          </td>
        </tr>
        <tr>
          <td><label for="option-forobj-not-supported">Foreign Obj Not Supported Msg</label></td>
          <td><input type="text" id="option-forobj-not-supported" /></td>
        </tr>
      </table>
    </div>
  
    <div id="data-container" class="col-xs-12 col-sm-6 col-md-6 data-container">
      <h3>JSON Tree Data Input
        <p>Add either stringified JSON data or a URL that links to your JSON. Example Data: 
          <pre><code>{
  node: {
    data: {
      dataValue1: "testValue1",
      dataValue2: "testValue2"
    },
    node {

    }
  }            
}</code></pre></p>
      </h3>
      <textarea class="textarea-input" id="node-data-input"></textarea>
    </div>

    <div class="col-xs-12 col-sm-6 col-md-6 data-container">
      <h3>Node HTML Template
        <p>Add the HTML template to be used for each node. Should be of the following format: 
          <pre><code>function(node) { 
  var htmlString = "";

  /* Build Template String */ 
  htmlString = htmlString + "&ltdiv&gt" + node.dataValue1 + "&lt/div&gt";
  htmlString = htmlString + "&ltdiv&gt" + node.dataValue2 + "&lt/div&gt";

  return htmlString; 
}</code></pre></p>
      </h3>
      <textarea class="textarea-input" id="node-html-template"></textarea>
    </div>
  
    <div class="col-xs-12 col-sm-6 col-md-6">
      <h3 class="header-with-desc">Unformatted User Settings
        <p>This unformatted json string can be copied and passed into your call to this plugin as user settings, in order to reproduce the manually configured tree.</p>
      </h3>
      <pre><code id="user-unformatted-settings" class="code-container"></code></pre>
    </div>

    <div class="col-xs-12 col-sm-6 col-md-6">
      <h3 class="header-with-desc">Formatted User Settings
        <p>This formatted json string contains the above user-specified settings, formatted for human readability.</p>
      </h3>
      <pre><code id="user-formatted-settings" class="code-container"></code></pre>
    </div>

    <div class="col-xs-12 col-sm-6 col-md-6">
      <h3 class="header-with-desc">Formatted Default Settings
        <p>This formatted json string contains the above user-specified settings, formatted for human readability.</p>
      </h3>
      <pre><code id="default-formatted-settings" class="code-container"></code></pre>
    </div>

    <div class="col-xs-12 col-sm-6 col-md-6">
      <h3 class="header-with-desc">Formatted Compiled Settings
        <p>This formatted json string contains a combination of the above default and user settings, with any user settings overriding the corresponding default settings except for classes, which are just added.</p>
      </h3>
      <pre><code id="compiled-formatted-settings" class="code-container"></code></pre>
    </div>

  </div>
</body>

<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script type="text/javascript" src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
<script type="text/javascript" src="http://underscorejs.org/underscore.js"></script>
<script type="text/javascript" src="treedrawerplugin.js"></script>

<script type="text/javascript">

  var refreshDataEl = function(el, data, formatted) {
    $(el).html('');

    if(formatted) {
      $(el).html(JSON.stringify(data, undefined, 2));
    } else {
      $(el).html(JSON.stringify(data));
    }

  };

  // We can use the extend method to merge userSettings with defaultSettings:
  // But with the added first parameter of TRUE to signify a DEEP COPY:
  var mergeSettings = function(defaultSettings, userSettings) {
    return $.extend( true, defaultSettings, userSettings );
  };

  var buildAndRefreshSettings = function() {
    var defaultObjSettings = buildDefaultObjSettings();
    var defaultSettings = addDefaultClassArraySettings(defaultObjSettings);
    refreshDataEl('#default-formatted-settings', defaultSettings, true);

    var userSettings = {};
    if($("input:radio[name='settings-source']:checked").val() === "user") {
      userSettings = buildUserSettings();
    }
    refreshDataEl('#user-unformatted-settings', userSettings, false);
    refreshDataEl('#user-formatted-settings', userSettings, true);

    var mergedSettings = mergeSettings(defaultSettings, userSettings);
    refreshDataEl('#compiled-formatted-settings', mergedSettings, true);

    return userSettings;
  };

  var buildAndRefreshTree = function() {
    var userSettings = buildAndRefreshSettings();

    if ($("input:radio[name='data-source']:checked").val() === "user" && $("#node-data-input").val() !== "") {
      userSettings.node = $("#node-data-input").val();
    }

    var newTreeContainerId = $.trim($("#option-tree-container-id").val()); 
    var currentContainerId  = newTreeContainerId || "#tree-container";

    $(currentContainerId).text('');
    $(currentContainerId).drawTree(userSettings);
  };

  // Add a click event to each addRow button
  //    - Adds a new element to the text input list
  //    - Each item in group included when compiling settings
  //    - When options are compiled, all empty boxes are ignored
  $(".add-row-button").click(function(e) {
    var self = this;
    var ul = $(self.dataset.listid);

    var li = document.createElement("li");
    li.className = "option-list-item";

    var input = document.createElement("input");
    input.type = "text";
    input.className = "option-list-item-input";

    li.appendChild(input);
    ul.append(li);
  });

  // Builds array of strings from a given unordered list ID
  var buildArrayFromList = function(listId) {
    var listItemsEl = document.getElementById(listId).getElementsByTagName('li');
    var outputList = [];
    for(var i = 0; i < listItemsEl.length; i++) {
      var listItemEl = listItemsEl[i];
      var itemInputEl = listItemEl.getElementsByTagName('input')[0];
      var listItemValue = $.trim(itemInputEl.value);
      if(listItemValue !== "") {
        outputList.push(listItemValue);
      }
    }
    return outputList;
  };

  var buildUserSettings = function() {
    var settings = {};
    
    if ($.trim($("#option-tree-container-id").val()) !== "") { 
      var newTreeContainerId = $.trim($("#option-tree-container-id").val()); 
      settings.treeContainerId = newTreeContainerId;
    }
    if ($.trim($("#option-child-node-name").val()) !== "") { 
      settings.childNodeName = $.trim($("#option-child-node-name").val()); 
    }
    if ($.trim($("#option-node-data-name").val()) !== "") { 
      settings.nodeDataName = $.trim($("#option-node-data-name").val()); 
    }

    if ($("input:radio[name='tree-orientation']:checked").val()) { 
      settings.treeOrientation = $("input:radio[name='tree-orientation']:checked").val(); 
    }
    if ($("input:radio[name='link-orientation']:checked").val()) { 
      settings.linkOrientation = $("input:radio[name='link-orientation']:checked").val(); 
    }
    if ($("input:radio[name='option-link-strategy']:checked").val()) { 
      settings.linkStrategy = $("input:radio[name='option-link-strategy']:checked").val(); 
    }
    
    if ($.trim($("#option-node-width").val()) !== "") {
      if(!settings.nodeSizing) {
        settings.nodeSizing = {};
      }
      settings.nodeSizing.width = parseInt($.trim($("#option-node-width").val()));
    }
    if ($.trim($("#option-node-height").val()) !== "" ) {
      if ( !settings.nodeSizing ) {
        settings.nodeSizing = {};
      }
      settings.nodeSizing.height = parseInt($.trim($("#option-node-height").val()));
    }
    if ( $.trim($("#option-node-depth-spacing").val()) !== "" ) {
      if ( !settings.nodeSpacing ) {
        settings.nodeSpacing = {};
      }
      settings.nodeSpacing.level = parseInt($.trim($("#option-node-depth-spacing").val()));
    }
    if ( $.trim($("#option-node-sibling-spacing").val()) !== "" ) {
      if( !settings.nodeSpacing ) {
        settings.nodeSpacing = {};
      }
      settings.nodeSpacing.span = parseInt($.trim($("#option-node-sibling-spacing").val()));
    }

    // Build class lists from groups of list entries 
    settings.nodeBkndClasses = buildArrayFromList("option-node-background-classes");
    settings.nodeHTMLClasses = buildArrayFromList("option-node-html-classes");
    settings.linkClasses = buildArrayFromList("option-link-body-classes");
    settings.arrowClasses = buildArrayFromList("option-link-arrow-classes");

    // Delete a class list if no text is added by the user
    if (settings.nodeBkndClasses.length === 0) { delete settings.nodeBkndClasses; }
    if (settings.nodeHTMLClasses.length === 0) { delete settings.nodeHTMLClasses; }
    if (settings.linkClasses.length === 0) { delete settings.linkClasses; }
    if (settings.arrowClasses.length === 0) { delete settings.arrowClasses; }

    if ($.trim($("#option-forobj-not-supported").val()) !== "") { settings.notSupportedMessage = $.trim($("#option-forobj-not-supported").val()); }
    if ($.trim($("#node-html-template").val()) !== "") { settings.nodeHTMLTemplate = $.trim($("#node-html-template").val()); }


    return settings;
  };
  //{ node: { name: "test3", node: [{  name: "test" }, {name: "test2" }] } }
  //

  var buildDefaultObjSettings = function() {
    var defaultSettings = {
      treeContainerId: '#tree-container',
      treeOrientation: 'down',
      linkOrientation: 'down',
      childNodeName: 'node',
      nodeDataName: 'data',
      linkStrategy: 'elbow',
      nodeSizing: {
        width: 20,
        height: 20
      },
      nodeSpacing: {
        level: 20,
        span: 20
      },
      nodeBkndClasses: [],
      nodeHTMLClasses: [],
      linkClasses: [],
      arrowClasses: [],
      notSupportedMessage: 'Sorry, d3 html templates are not supported by your browser.',
      nodeHTMLTemplate: function (d) {
        return '<div id="node-template">' + d.dataValue + '</div>';
      }
    };

    defaultSettings.nodeBkndClasses.push('node-background');
    defaultSettings.nodeHTMLClasses.push('node-html-container');
    defaultSettings.linkClasses.push('link-html-container');
    defaultSettings.arrowClasses.push('arrow-html-container');

    return defaultSettings;
  };

  var addDefaultClassArraySettings = function(obj) {

    if(obj.nodeBkndClasses.indexOf('node-background') === -1) {
      obj.nodeBkndClasses.push('node-background');
    }
    if(obj.nodeHTMLClasses.indexOf('node-html-container') === -1) {
      obj.nodeHTMLClasses.push('node-html-container');
    }
    if(obj.linkClasses.indexOf('link-html-container') === -1) {
      obj.linkClasses.push('link-html-container');
    }
    if(obj.arrowClasses.indexOf('arrow-html-container') === -1) {
      obj.arrowClasses.push('arrow-html-container');
    }

    return obj;
  };

</script>
</html>
